version: '3.8'
services:
  proxy:
    image: 'jc21/nginx-proxy-manager:latest'
    restart: unless-stopped
    ports:
      - '80:80'
      - '81:81'
      - '443:443'
    volumes:
      - ../nginx/data:/data
      - ../nginx/letsencrypt:/etc/letsencrypt
    network_mode: 'host'
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
  keycloak:
    ports:
      - '8080:8080'
      - '9000:9000'
    image: quay.io/keycloak/keycloak:latest
    command: start
    environment:
        KC_HOSTNAME: 'auth.lukaweis.de'
        KC_PROXY: 'edge'
        KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
        KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
        QUARKUS_TRANSACTION_MANAGER_ENABLE_RECOVERY: 'true'
    volumes:
        - ../keycloak:/opt/keycloak/data
        - ../keycloak-themes:/opt/keycloak/providers
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
  kaeltebus-api:
    ports:
      - '8081:8080'
    image: kaeltebusapi:latest
    environment:
        ASPNETCORE_ENVIRONMENT: 'Production'
        CORS_ORIGINS: 'https://ulm.kaelte-bus.de'
    volumes:
        - ../backend/db:/opt/kaeltebus-api/db
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
  kaeltebus-ui:
    ports:
      - '8082:80'
    image: kaeltebusui:latest
    environment:
        VITE_API_BASE_URL: 'https://ulm.kaelte-bus.de/api'
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"