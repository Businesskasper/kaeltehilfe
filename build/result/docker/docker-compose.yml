version: '3.8'
services:
  proxy:
    image: 'jc21/nginx-proxy-manager:latest'
    restart: unless-stopped
    ports:
      - '80:80'
      - '81:81'
      - '443:443'
    volumes:
      - ../nginx/data:/data
      - ../nginx/letsencrypt:/etc/letsencrypt
    network_mode: 'host'
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
  keycloak:
    ports:
      - '8080:8080'
      - '9000:9000'
    image: quay.io/keycloak/keycloak:26.0.4
    command: start
    environment:
        KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN}
        KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
        QUARKUS_TRANSACTION_MANAGER_ENABLE_RECOVERY: 'true'
        KC_PROXY_HEADERS: 'xforwarded'
        KC_HTTP_ENABLED: 'true'
        KC_HOSTNAME_STRICT: 'false'
        KC_HTTP_RELATIVE_PATH: /
        KC_PROXY_ADDRESS_FORWARDING: 'true'
        KC_SPI_X509CERT_LOOKUP_PROVIDER: 'nginx'
        KC_SPI_X509CERT_LOOKUP_NGINX_SSL_CLIENT_CERT: 'X-Client-Cert'
        X509_CA_BUNDLE: '/etc/x509/https/rootCA.crt'
    volumes:
        - ../keycloak/themes:/opt/keycloak/providers
        - ../keycloak/data:/opt/keycloak/data
        - ../keycloak/x509:/etc/x509/https
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
    depends_on:
      proxy:
        condition: service_completed_successfully
        restart: true
  api:
    ports:
      - '8081:8080'
    image: kaeltebus-api:latest
    environment:
        ASPNETCORE_ENVIRONMENT: 'Production'
        CORS_ORIGINS: 'https://ulm.kaelte-bus.de'
        ROOT_CERT_PASSWORD: ${ROOT_CERT_PASSWORD}
        KC_CLIENT_SECRET: ${KC_CLIENT_SECRET}
    volumes:
        - ../kaeltebus-api/db:/opt/kaeltebus-api/db
        - ../kaeltebus-api/cert:/opt/kaeltebus-api/cert
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
    depends_on:
      keycloak:
        condition: service_completed_successfully
        restart: true
      proxy:
        condition: service_completed_successfully
        restart: true
  ui:
    ports:
      - '8082:80'
    image: kaeltebus-ui:latest
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
    depends_on:
      keycloak:
        condition: service_completed_successfully
        restart: true
      proxy:
        condition: service_completed_successfully
        restart: true